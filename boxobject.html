<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>直方体オブジェクト</title>
    <script src="js/three.js_r75/build/three.js"></script>
    <script src="js/three.js_r75/examples/js/controls/TrackballControls.js"></script>
    <!--   トラックボール用ライブラリ -->
    <style>
        * {
            padding: 0px;
            margin: 0px
        }

        div#canvas-frame {
            width: 500px;
            height: 500px;
            overflow:hidden;
        }
    </style>
    <script>
        ////////////////////////////    
        //windowイベントの定義
        ////////////////////////////
        window.addEventListener("load", function() {
            resizeTo(516, 539);
            threeStart();
        });

        ////////////////////////////    
        //Thre.jsスタート関数の定義
        ////////////////////////////
        function threeStart() {
            initThree(); //Three.js初期化関数の実行
            initObject(); //オブジェクト初期化関数の実行
            initCamera(); //カメラ初期化関数の実行
            loop(); //無限ループ関数の実行
        }

        //////////////////////////////
        //Three.js初期化関数の定義
        //////////////////////////////
        //グローバル変数の宣言

        var renderer, //レンダラーオブジェクト
            scene, //シーンオブジェクト
            canvasFrame; //キャンバスフレームのDOM要素
        function initThree() {
            //キャンバスフレームDOM要素の取得
            canvasFrame = document.getElementById('canvas-frame');
            //レンダラーオブジェクトの生成
            renderer = new THREE.WebGLRenderer({
                antialias: true
            });
            //renderer = new THERE.CanvasRenderer();


            if (!renderer) alert('Three.js の初期化に失敗しました。');
            //レンダラーのサイズの変更
            renderer.setSize(canvasFrame.clientWidth,
                canvasFrame.clientHeight);
            //キャンバスフレームDOM要素にcanvas要素を追加
            canvasFrame.appendChild(renderer.domElement);

            //レンダラークリアカラーの設定
            renderer.setClearColor(0x000000, 1.0);

            //シーンオブジェクトの生成
            scene = new THREE.Scene();
        }

        ///////////////////////////////////////////////////
        //カメラ初期化関数の定義
        ///////////////////////////////////////////////////

        //グローバル変数の宣言
        var camera;

        function initCamera() {
            //カメラオブジェクトの生成
            camera = new THREE.PerspectiveCamera(45,
                canvasFrame.clientWidth / canvasFrame.clientHeight, 1, 10000);
            //カメラ位置の設定
            camera.position.set(100, 100, 100);
            //カメラの上のベクトルの設定
            camera.up.set(0, 0, 1);
            //カメラ中心位置のベクトルの設定
            camera.lookAt({
                x: 0,
                y: 0,
                z: 0
            }); //トラックボール利用時は自動的に無効

            //トラックボールオブジェクトの宣言
            trackball = new THREE.TrackballControls(camera, canvasFrame);

            //トラックボール動作範囲のサイズとオフセットの設定
            trackball.screen.width = canvasFrame.clientWidth;

            trackball.screen.height = canvasFrame.clientHeight;

            trackball.screen.offsetLeft =
                canvasFrame.getBoundingClientRect().left; //左をオフセット

            trackball.screen.offsetTop =
                canvasFrame.getBoundingClientRect().top; //右をオフセット

            //トラックボールの回転無効化と回転速度の設定
            trackball.noRotate = false;
            trackball.rotatespeed = 4.0;

            //トラックボールの拡大無効化と拡大速度の設定
            trackball.noZoom = false;
            trackball.zoomSpeed = 1.0;
            trackball.target = new THREE.Vector3(0, 0, 0);

            //トラックボールのスタティックムーヴの有効化
            trackball.staticMoving = true;
            //トラックボールのダイナミックムーブ時の減衰定数
            trackball.dynamicDampingFactor = 0.3;
        }


        ///////////////
        //オブジェクト初期化関数の定義
        //////////////////

        //グローバル変数の宣言
        var axis; //軸オブジェクト
        var cube; //直方体オブジェクト
        function initObject() {
            //軸オブジェクトの生成
            axis = new THREE.AxisHelper(100);
            //軸オブジェクトのシーンへの追加
            scene.add(axis);
            //軸オブジェクトの位置座標を設定
            axis.position.set(0, 0, 0);

            //形状オブジェクトの宣言と生成
            var geometry = new THREE.BoxGeometry(50, 50, 50);
            //材質オブジェクトの宣言と生成
            var material = new THREE.MeshNormalMaterial();
            //直方体オブジェクトの生成
            cube = new THREE.Mesh(geometry, material);
            //直方体オブジェクトのシーンへの追加
            scene.add(cube);
            //直方体オブジェクトの位置座標を設定
            cube.position.set(0, 0, 0);

        }

        /////////////////////
        ////無限ループ関数の定義
        ////////////////////

        //グローバル変数の宣言
        var step = 0; //ステップ数
        function loop() {
            //トラックボールによるカメラオブジェクトのプロパティの更新
            trackball.update();

            //ステップ数のインクリメント
            step++;

            //レンダリング
            renderer.render(scene, camera);

            //画像生成
            makePicture();

            //loop関数の呼び出し
            requestAnimationFrame(loop);

        }

        ////////////
        //画像生成用
        ///////////

        var makePictureFlag = false;

        //画像作成用イベント
        window.addEventListener('keydown', function(e) {
            //キーボードイベント時のキー取得
            var keyChar = String.fromCharCode(e.keyCode).toLowerCase();

            //キーボードのsが押された場合
            if (keyChar == "s") {
                makePictureFlag = true;
            }


        });

        //画像作成関数
        function makePicture() {
            if (!makePictureFlag) return;

            //グラフィクスが描写されたcanvas要素
            var canvas = render.domElement;

            //a要素の生成
            var a = document.createElement("a");
            //canvas要素→DataURL形式
            a.href = canvas.toDataURL("image/png");
            //PNGファイル名の命名
            a.download = "picture";
            a.innerHTML = "ダウンロード";

            //id="thumbnails"のdiv要素の子要素にa要素を追加
            document.getElementsByTagName("body");
            [0].appendChild(a);

            makePictureFlag = false;

        }
    </script>

</head>

<body>


    <div id="canvas-frame"></div>

</body>
</html>